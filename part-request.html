<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Part Request Form</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .form-container {
            max-width: 800px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .part-table img {
            max-width: 80px;
            height: auto;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        /* Custom toast styling that doesn't depend on Bootstrap JS */
        .custom-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            min-width: 250px;
        }
    </style>
<body class="bg-light">
    <div class="container py-5">
        <!-- Session Error Message -->
        <div id="session-error" class="alert alert-danger text-center" style="display: none;">
            <h4 class="alert-heading">Session Expired</h4>
            <p>Please refresh the page and try again.</p>
        </div>

        <!-- Main Form -->
        <div id="main-form" class="form-container p-4 mb-4" style="display: none;">
            <h2 class="mb-4 text-center text-primary">Part Request Form</h2>
            
            <!-- Part Selection Form -->
            <form id="part-form" class="mb-4">
                <div class="row g-3">
                    <!-- Part Selection -->
                    <div class="col-md-6">
                        <label class="form-label">Select Part</label>
                        <select id="part-select" class="form-select" required>
                            <option value="">Loading parts...</option>
                        </select>
                    </div>

                    <!-- Quantity Selection -->
                    <div class="col-md-3">
                        <label class="form-label">Quantity</label>
                        <select id="quantity-select" class="form-select" required>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>

                    <!-- Provider Selection -->
                    <div class="col-md-3">
                        <label class="form-label">Provider</label>
                        <select id="provider-select" class="form-select" required>
                            <option value="Serviz">Serviz</option>
                            <option value="Service Center">Service Center</option>
                        </select>
                    </div>

                    <!-- Serial Number -->
                    <div class="col-md-6">
                        <label class="form-label">Serial Number</label>
                        <input type="text" id="serial-input" class="form-control" 
                               placeholder="Enter serial number" required>
                    </div>

                    <!-- Photo Upload -->
                    <div class="col-md-6">
                        <label class="form-label">Part Photo</label>
                        <input type="file" id="photo-input" 
                               class="form-control" accept="image/*" required>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-primary" id="add-part-btn">
                        <i class="bi bi-plus-circle"></i> Add Part
                    </button>
                    <button type="button" class="btn btn-warning" id="clear-list-btn">
                        <i class="bi bi-x-circle"></i> Clear List
                    </button>
                </div>
            </form>

            <!-- Parts List Table -->
            <div class="table-responsive">
                <table class="table table-hover part-table">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Part Details</th>
                            <th>Qty</th>
                            <th>Serial</th>
                            <th>Provider</th>
                            <th>Photo</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="parts-list-body"></tbody>
                </table>
            </div>

            <!-- Submission Section -->
            <div class="d-grid mt-4">
                <button id="submit-btn" class="btn btn-success btn-lg" disabled>
                    <i class="bi bi-check-circle"></i> Submit Request
                </button>
            </div>
            
            <!-- Result Message -->
            <div id="result-message" class="mt-3"></div>
        </div>
    </div>

    <script>
        // Configuration Constants
        const BASE_URL = 'http://172.188.56.173:8008';
        const BASE_URL_ORDERS = 'http://172.188.56.173:8009';
        const STATUS_API_URL = 'http://172.188.56.173:8009/api/v1/order-statuses';
        const API = {
            PARTS: `${BASE_URL}/api/v1/spares/dd`,
            UPLOAD: `${BASE_URL}/api/v1/upload?type=order-documents`,
            ORDERS: `${BASE_URL_ORDERS}/api/v1/orders`
        };

        // State Management
        let partsCatalog = new Map();
        let selectedParts = [];
        let sessionParams = {};

        // DOM Elements
        const elements = {
            mainForm: document.getElementById('main-form'),
            sessionError: document.getElementById('session-error'),
            partSelect: document.getElementById('part-select'),
            partsListBody: document.getElementById('parts-list-body'),
            submitBtn: document.getElementById('submit-btn'),
            resultMessage: document.getElementById('result-message')
        };

        // Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            await validateSession();
            await loadPartsCatalog();
            setupEventListeners();
        });

        // Session Management
        async function validateSession() {
            const requiredParams = [
                'category', 'brand', 'modelNo', 'token', 
                'orderId', 'currentStatus', 'userId', 'userName','id','sender'
            ];
            const urlParams = new URLSearchParams(window.location.search);
            
            requiredParams.forEach(param => {
                sessionParams[param] = urlParams.get(param) || sessionStorage.getItem(param);
                sessionStorage.setItem(param, sessionParams[param]);
            });

            if (requiredParams.some(param => !sessionParams[param])) {
                elements.sessionError.style.display = 'block';
                return;
            }
            
            elements.mainForm.style.display = 'block';
            window.history.replaceState({}, '', window.location.pathname);
        }

        // Data Loading
        async function loadPartsCatalog() {
            try {
                const response = await fetch(`${API.PARTS}?${
                    new URLSearchParams({
                        category: sessionParams.category,
                        brand: sessionParams.brand,
                        modelNo: sessionParams.modelNo
                    })
                }`, {
                    headers: { Authorization: `Bearer ${sessionParams.token}` }
                });

                const { payload } = await response.json();
                elements.partSelect.innerHTML = '<option value="">Select a part</option>';
                
                payload.items.forEach(part => {
                    partsCatalog.set(part._id, part);
                    elements.partSelect.innerHTML += `
                        <option value="${part._id}">
                            ${part.name} (${part.code})
                        </option>
                    `;
                });
            } catch (error) {
                console.error('Failed to load parts:', error);
                showToast('Error loading parts catalog', 'danger');
            }
        }

        // Event Handlers
        function setupEventListeners() {
            document.getElementById('add-part-btn').addEventListener('click', addPart);
            document.getElementById('clear-list-btn').addEventListener('click', clearPartsList);
            document.getElementById('submit-btn').addEventListener('click', submitRequest);
        }

        // Business Logic
        async function addPart() {
            const partData = validatePartForm();
            if (!partData) return;

            try {
                partData.image = await uploadPartPhoto(partData.photo);
                selectedParts.push(partData);
                updatePartsList();
                resetPartForm();
                elements.submitBtn.disabled = false;
                showToast('Part added successfully', 'success');
            } catch (error) {
                showToast(error.message, 'danger');
            }
        }

        function validatePartForm() {
            const inputs = {
                partId: elements.partSelect.value,
                quantity: document.getElementById('quantity-select').value,
                provider: document.getElementById('provider-select').value,
                serial: document.getElementById('serial-input').value,
                photo: document.getElementById('photo-input').files[0]
            };

            if (Object.values(inputs).some(value => !value)) {
                showToast('Please fill all fields', 'warning');
                return null;
            }

            const part = partsCatalog.get(inputs.partId);
            if (!part) {
                showToast('Invalid part selected', 'danger');
                return null;
            }

            return {
                ...inputs,
                partData: part,
                price: part.sellingPrice,
                totalPrice: part.sellingPrice * inputs.quantity
            };
        }

        async function uploadPartPhoto(file) {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch(API.UPLOAD, {
                method: 'POST',
                headers: { Authorization: `Bearer ${sessionParams.token}` },
                body: formData
            });

            if (!response.ok) throw new Error('Photo upload failed');
            return (await response.json()).payload;
        }

        // UI Updates
        function updatePartsList() {
            elements.partsListBody.innerHTML = selectedParts
                .map((part, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${part.partData.name}<br>
                            <small class="text-muted">${part.partData.code}</small>
                        </td>
                        <td>${part.quantity}</td>
                        <td>${part.serial}</td>
                        <td>${part.provider}</td>
                        <td><img src="${part.image}" alt="Part photo" class="img-thumbnail"></td>
                        <td>
                            <button class="btn btn-sm btn-danger" 
                                onclick="removePart(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
        }

        function resetPartForm() {
            document.getElementById('part-form').reset();
            document.getElementById('quantity-select').value = '1';
        }

        // Data Submission
        async function submitRequest() {
            elements.submitBtn.disabled = true;
            
            try {
                // 1. First update the order with parts
                const orderResponse = await fetch(`${API.ORDERS}/${sessionParams.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${sessionParams.token}`
                    },
                    body: JSON.stringify({ parts: selectedParts })
                });

                if (!orderResponse.ok) throw new Error('Order update failed');

                // 2. Then update the order status
                const statusResponse = await fetch(STATUS_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${sessionParams.token}`
                    },
                    body: JSON.stringify({
                        order: { 
                            orderId: sessionParams.orderId, 
                            _id: sessionParams.id 
                        },
                        lastStatus: sessionParams.currentStatus,
                        currentStatus: "parts_approval_pending",
                        state: "Parts Request",
                        statusChangeFrom: "admin",
                        changeFrom: "admin",
                        user: { 
                            _id: '6464bf7e4f51a5937348796f', 
                            firstName: sessionParams.userName ,
                            email: "9934012217@serviz.com",
                        }
                    })
                });

                if (!statusResponse.ok) throw new Error('Status update failed');

                // Show success message
                elements.resultMessage.innerHTML = `
                    <div class="alert alert-success">
                        ✅ Request submitted successfully!
                    </div>
                `;
                
                // Clear the parts list
                clearPartsList();
                
                // Close the window after 2 seconds
                setTimeout(() => window.close(), 2000);
            } catch (error) {
                console.error('Submission error:', error);
                elements.resultMessage.innerHTML = `
                    <div class="alert alert-danger">
                        ❌ Error: ${error.message}
                    </div>
                `;
                elements.submitBtn.disabled = false;
            }
        }

        // Utility Functions
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-bg-${type} border-0`;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close me-2 m-auto" 
                        data-bs-dismiss="toast"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            new bootstrap.Toast(toast).show();
            setTimeout(() => toast.remove(), 3000);
        }

        function removePart(index) {
            selectedParts.splice(index, 1);
            updatePartsList();
            elements.submitBtn.disabled = selectedParts.length === 0;
        }

        function clearPartsList() {
            selectedParts = [];
            updatePartsList();
            elements.submitBtn.disabled = true;
            showToast('Parts list cleared', 'warning');
        }
    </script>
</body>
</html>